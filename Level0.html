<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Level 0 - Endless Office</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <style>
      body {
        font-family: "Arial", sans-serif;
        margin: 0;
        background-color: #000;
        color: #fff;
        overflow: hidden;
        /* Improved text selection for better UX */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      #blocker {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      #instructions {
        width: 50%;
        padding: 20px;
        background-color: #111;
        border: 2px solid #333;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(255, 255, 100, 0.2);
        cursor: pointer;
      }
      #instructions h1 {
        font-size: 2.5em;
        color: #ffff99;
        margin-top: 0;
      }
      #instructions p {
        font-size: 1.2em;
        color: #ccc;
        line-height: 1.6;
      }
      #instructions .key {
        background-color: #333;
        color: #fff;
        padding: 3px 8px;
        border-radius: 5px;
        font-weight: bold;
        font-family: "Courier New", Courier, monospace;
        border: 1px solid #555;
      }

      /* HUD - Heads Up Display */
      #hud {
        position: absolute;
        bottom: 20px;
        left: 20px;
        color: white;
        z-index: 100;
        display: none; /* Hidden until game starts */
      }
      .hud-item {
        margin-bottom: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #444;
        width: 200px;
      }
      .hud-item label {
        font-size: 1em;
        font-weight: bold;
        color: #ffff99;
        display: block;
        margin-bottom: 5px;
      }
      .bar-container {
        width: 100%;
        height: 20px;
        background-color: #333;
        border-radius: 5px;
        overflow: hidden;
        border: 1px solid #555;
      }
      #stamina-bar,
      #sanity-bar {
        height: 100%;
        width: 100%;
        background-color: #4caf50; /* Green for stamina */
        transition: width 0.2s linear;
      }
      #sanity-bar {
        background-color: #4c8faf; /* Blue for sanity */
      }

      /* Crosshair */
      #crosshair {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 4px;
        height: 4px;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 100;
        display: none;
      }

      /* Interaction Prompt */
      #interaction-prompt {
        position: absolute;
        top: 60%;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 1.1em;
        display: none;
        z-index: 100;
      }
      #interaction-prompt .key {
        background-color: #eee;
        color: #000;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
      }

      /* Inventory Screen */
      #inventory-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        z-index: 200;
      }
      #inventory-grid {
        display: grid;
        grid-template-columns: repeat(3, 80px);
        grid-gap: 15px;
        background-color: #1a1a1a;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #444;
      }
      .inventory-slot {
        width: 80px;
        height: 80px;
        background-color: #333;
        border: 2px solid #555;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.9em;
        color: #888;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s;
      }
      .inventory-slot:hover,
      .inventory-slot.selected {
        background-color: #444;
        border-color: #ffff99;
      }
      .inventory-slot .item-name {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 3px 5px;
        border-radius: 4px;
        font-size: 0.8em;
      }
      .inventory-slot .item-quantity {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: #ffff99;
        color: #000;
        font-weight: bold;
        padding: 2px 5px;
        border-radius: 50%;
        font-size: 0.8em;
      }
      #inventory-controls {
        margin-left: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .inventory-button {
        padding: 12px 20px;
        background-color: #333;
        color: #fff;
        border: 2px solid #555;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        transition: background-color 0.2s, border-color 0.2s;
      }
      .inventory-button:hover {
        background-color: #444;
        border-color: #ffff99;
      }
      .inventory-button:disabled {
        background-color: #222;
        color: #666;
        border-color: #444;
        cursor: not-allowed;
      }

      /* Hotbar */
      #hotbar {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: grid;
        grid-template-columns: repeat(3, 60px);
        grid-gap: 10px;
        z-index: 100;
      }
      .hotbar-slot {
        width: 60px;
        height: 60px;
        background-color: rgba(51, 51, 51, 0.7);
        border: 2px solid #555;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #888;
        font-size: 0.8em;
        position: relative;
      }
      .hotbar-slot.selected {
        border-color: #ffff99;
        background-color: rgba(68, 68, 66, 0.9);
      }
      .hotbar-slot .item-name {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 0.7em;
      }
      .hotbar-slot .hotkey-label {
        position: absolute;
        top: 2px;
        left: 4px;
        color: #ccc;
        font-size: 0.9em;
        font-weight: bold;
      }
      .hotbar-slot .item-quantity {
        position: absolute;
        bottom: 3px;
        right: 3px;
        background-color: #ffff99;
        color: #000;
        font-weight: bold;
        padding: 1px 4px;
        border-radius: 50%;
        font-size: 0.7em;
      }

      /* Game Over / Win Screens */
      .overlay-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        text-align: center;
        z-index: 300;
        color: #ff4d4d;
      }
      .overlay-screen h1 {
        font-size: 4em;
        margin: 0;
      }
      .overlay-screen p {
        font-size: 1.5em;
        color: #ccc;
      }
      #game-win-screen {
        color: #4dff4d;
      }
      .restart-button {
        margin-top: 20px;
        padding: 15px 30px;
        font-size: 1.2em;
        background-color: #333;
        color: #fff;
        border: 2px solid #555;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s;
      }
      .restart-button:hover {
        background-color: #444;
        border-color: #ffff99;
      }
    </style>
    <!-- Importmap for Three.js modules -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <div id="blocker">
      <div id="instructions">
        <h1>Level 0: The Endless Office</h1>
        <p>
          You've no-clipped out of reality. All that remains is the hum of the
          fluorescents and the smell of damp carpet.
        </p>
        <p>
          <span class="key">Click to Begin</span>
        </p>
        <br />
        <p>
          <span class="key">W, A, S, D</span> - Move |
          <span class="key">Mouse</span> - Look |
          <span class="key">Space</span> - Jump
        </p>
        <p>
          <span class="key">Shift</span> - Sprint |
          <span class="key">Ctrl</span> - Crouch | <span class="key">F</span> -
          Flashlight
        </p>
        <p>
          <span class="key">E</span> - Inventory |
          <span class="key">1, 2, 3</span> - Hotbar |
          <span class="key">Q</span> - Use Item
        </p>
        <p><span class="key">Click</span> - Pick Up Item</p>
      </div>
    </div>

    <!-- HUD Elements -->
    <div id="hud">
      <div class="hud-item">
        <label>Stamina</label>
        <div class="bar-container">
          <div id="stamina-bar"></div>
        </div>
      </div>
      <div class="hud-item">
        <label>Sanity</label>
        <div class="bar-container">
          <div id="sanity-bar"></div>
        </div>
      </div>
    </div>

    <div id="crosshair"></div>

    <div id="interaction-prompt">
      Press <span class="key">E</span> to pick up
    </div>

    <!-- Inventory Screen -->
    <div id="inventory-screen">
      <div id="inventory-grid">
        <!-- 9 slots will be generated by JS -->
      </div>
      <div id="inventory-controls">
        <button class="inventory-button" id="inv-use">Use</button>
        <button class="inventory-button" id="inv-drop">Drop</button>
        <button class="inventory-button" id="inv-hotbar-1">
          Move to Hotbar 1
        </button>
        <button class="inventory-button" id="inv-hotbar-2">
          Move to Hotbar 2
        </button>
        <button class="inventory-button" id="inv-hotbar-3">
          Move to Hotbar 3
        </button>
      </div>
    </div>

    <!-- Hotbar -->
    <div id="hotbar">
      <div class="hotbar-slot" id="hotbar-0">
        <span class="hotkey-label">1</span>
        <span class="item-name"></span>
        <span class="item-quantity"></span>
      </div>
      <div class="hotbar-slot" id="hotbar-1">
        <span class="hotkey-label">2</span>
        <span class="item-name"></span>
        <span class="item-quantity"></span>
      </div>
      <div class="hotbar-slot" id="hotbar-2">
        <span class="hotkey-label">3</span>
        <span class="item-name"></span>
        <span class="item-quantity"></span>
      </div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="overlay-screen">
      <div>
        <h1>You Fell</h1>
        <p>
          The pit claims another... <br />Your sanity slips away as you fall
          into the darkness.
        </p>
        <button class="restart-button" id="restart-button-dead">Restart</button>
      </div>
    </div>

    <!-- Game Win Screen -->
    <div id="game-win-screen" class="overlay-screen">
      <div>
        <h1>You Escaped...?</h1>
        <p>
          You push through the discolored door... <br />...only to find yourself
          somewhere else.
        </p>
        <button class="restart-button" id="restart-button-win">
          Play Again
        </button>
      </div>
    </div>

    <!-- Main Game Script -->
    <script type="module">
      import * as THREE from "three";
      import { PointerLockControls } from "three/addons/controls/PointerLockControls.js";
      import { BufferGeometryUtils } from "three/addons/utils/BufferGeometryUtils.js";

      let camera, scene, renderer, controls;
      let playerVelocity = new THREE.Vector3();
      let playerDirection = new THREE.Vector3();

      const objects = []; // For collision detection
      const interactableItems = []; // For item pickup

      let moveForward = false;
      let moveBackward = false;
      let moveLeft = false;
      let moveRight = false;
      let canJump = false;
      let isCrouching = false;
      let isSprinting = false;

      let prevTime = performance.now();

      // Game state
      let gameRunning = false;
      let inventoryOpen = false;
      let gameWon = false; // Flag to stop exit despawning after win
      let isRedShiftActive = false; // Flag for red level shift
      let redShiftActivationChunk = null; // NEW: Tracks where red shift started
      const RED_SHIFT_EXIT_DISTANCE = 5; // NEW: Chunks to travel in red shift to exit

      // Player stats
      let playerStamina = 100;
      let playerSanity = 100;
      const maxStamina = 100;
      const maxSanity = 100;
      let sanityDrainTimer = 0;

      // Player physics constants
      const playerSpeed = 8.0;
      const playerSprintSpeed = 14.0;
      const playerCrouchSpeed = 4.0;
      const playerGravity = 30.0;
      const playerJumpHeight = 8.0;
      const playerHeight = 1.8;
      const playerCrouchHeight = 1.0;
      const playerRadius = 0.4; // Player collision radius

      // Maze generation
      const CHUNK_SIZE = 20; // 20m x 20m chunks
      const WALL_HEIGHT = 3;
      const WALL_THICKNESS = 0.2;
      const TILE_SIZE = 1; // 1m x 1m ceiling tiles

      // --- NEW: User-configurable variables ---
      const MISSING_TILE_PROBABILITY = 0.08; // (Default: 0.08)
      const CEILING_JUNK_DENSITY = 0.3; // (Default: 0.3)
      const RED_SHIFT_DISTANCE = 20; // --- NEW: Chunks from spawn to trigger red shift

      // --- NEW: Decal Customization ---
      const RANDOM_TORN_WALLPAPER_PROBABILITY = 0.2; // (Default: 0.2) Chance for torn paper to spawn
      const RANDOM_GRAFFITI_PROBABILITY = 0.1; // (Default: 0.1) Chance for random graffiti to spawn
      const GUIDE_ARROW_PROBABILITY = 0.95; // (Default: 0.95) Chance for a guide arrow to spawn near the exit
      const TORN_PAPER_MIN_WIDTH = 0.5; // (Default: 0.5)
      const TORN_PAPER_MAX_WIDTH = 4.0; // (Default: 4.0, which is one wall panel)
      const TORN_PAPER_MIN_HEIGHT = 0.5; // (Default: 0.5)
      const TORN_PAPER_MAX_HEIGHT = 3.0; // (Default: 3.0, which is full wall height)

      // Special rooms & Exit Logic
      let exitChunkCoords = null; // Stores {x, z} of the current exit chunk, null if none spawned
      let exitTriggerMesh = null; // Reference to the exit trigger mesh for removal
      let exitSignMesh = null; // Reference to the exit sign mesh
      let exitDoorFrameMesh = null; // Reference to the exit door frame
      let exitDoorMesh = null; // Reference to the exit door
      const MIN_EXIT_DISTANCE_SQ = 5 * 5; // Exit can only spawn beyond chunk distance 5 (squared)
      const EXIT_SPAWN_PROBABILITY = 0.05; // 5% chance per eligible chunk

      const PITFALL_PROBABILITY = 0.2; // 8% chance for a pitfall room
      const PIT_GRID_SIZE = 5; // Grid size for pitfall room (9x9)
      const PIT_PATH_WIDTH = 0.4; // Increased path width slightly
      const PIT_PATH_HEIGHT = 0.2; // Height of the path beam itself
      const PIT_WALL_COUNT = PIT_GRID_SIZE + 1; // Need lines on both sides of pits
      const PIT_TOTAL_PATH_WIDTH = PIT_WALL_COUNT * PIT_PATH_WIDTH;
      const PIT_SIZE = (CHUNK_SIZE - PIT_TOTAL_PATH_WIDTH) / PIT_GRID_SIZE; // Recalculated size of each pit
      const PIT_DEPTH = 100; // How deep the pits go (Increased from 30)

      let currentChunk = { x: 0, z: 0 };
      let generatedChunks = new Map();
      const globalRandom = Math.random; // Use unseeded random for pitfall/exit check initially

      // --- DOM Elements ---
      const blocker = document.getElementById("blocker");
      const instructions = document.getElementById("instructions");
      const hud = document.getElementById("hud");
      const crosshair = document.getElementById("crosshair");
      const staminaBar = document.getElementById("stamina-bar");
      const sanityBar = document.getElementById("sanity-bar");
      const interactionPrompt = document.getElementById("interaction-prompt");

      const inventoryScreen = document.getElementById("inventory-screen");
      const inventoryGrid = document.getElementById("inventory-grid");
      const hotbar = [
        document.getElementById("hotbar-0"),
        document.getElementById("hotbar-1"),
        document.getElementById("hotbar-2"),
      ];
      let selectedHotbarSlot = 0;

      const invUseButton = document.getElementById("inv-use");
      const invDropButton = document.getElementById("inv-drop");
      const invHotbarButtons = [
        document.getElementById("inv-hotbar-1"),
        document.getElementById("inv-hotbar-2"),
        document.getElementById("inv-hotbar-3"),
      ];

      const gameOverScreen = document.getElementById("game-over-screen");
      const gameWinScreen = document.getElementById("game-win-screen");
      const restartButtonDead = document.getElementById("restart-button-dead");
      const restartButtonWin = document.getElementById("restart-button-win");

      let flashlight, ambientLight;
      let audioListener, humSound;
      let wallpaperMaterial, // --- RE-ADDED
        floorMaterial,
        ceilingMaterial,
        deskMaterial,
        chairMaterial,
        puddleMaterial,
        pipeMaterial,
        exitWallMaterial;

      // --- RE-ADDED Decal Materials ---
      let graffitiMaterial, // Base material for random graffiti
        tornWallpaperMaterial; // New material for torn wallpaper

      let pitPathMaterial, // Material for the paths in pit rooms
        darkPitMaterial, // Dark material for inside pits
        roofMaterial; // --- NEW: Material for the void roof

      // --- Inventory System ---
      let inventory = new Array(9).fill(null);
      let hotbarItems = new Array(3).fill(null); // Mirrors the 3 hotbar slots
      let selectedInventorySlot = -1;

      // Item definitions
      const ITEMS = {
        flashlight: {
          name: "Flashlight",
          stackable: false,
          use: (item, index, source) => {
            toggleFlashlight();
          },
        },
        almond_water: {
          name: "Almond Water",
          stackable: true,
          maxStack: 5,
          use: (item, index, source) => {
            playerSanity = maxSanity;
            item.quantity--;
            if (item.quantity <= 0) {
              if (source === "inventory") inventory[index] = null;
              if (source === "hotbar") hotbarItems[index] = null;
            }
            updateInventoryUI();
            updateHotbarUI();
          },
        },
      };

      // --- Texture Generation ---
      /**
       * Creates the BASE wallpaper texture, without decals.
       */
      function createWallpaperTexture() {
        const canvas = document.createElement("canvas");
        canvas.width = 512;
        canvas.height = 512;
        const context = canvas.getContext("2d");

        // 1. Base mono-yellow
        context.fillStyle = "#C2B280"; // A sickly, slightly brownish yellow
        context.fillRect(0, 0, 512, 512);

        // 2. Subtle pattern
        context.fillStyle = "rgba(0,0,0,0.02)";
        for (let i = 0; i < 512; i += 8) {
          context.fillRect(i, 0, 1, 512);
          context.fillRect(0, i, 512, 1);
        }

        // 3. Grime and stains
        for (let i = 0; i < 70; i++) {
          context.fillStyle = `rgba(0, 0, 0, ${Math.random() * 0.15 + 0.05})`;
          context.beginPath();
          context.arc(
            Math.random() * 512,
            Math.random() * 512,
            Math.random() * 40 + 15,
            0,
            Math.PI * 2
          );
          context.fill();
        }
        context.fillStyle = `rgba(101, 67, 33, ${Math.random() * 0.2 + 0.1})`;
        context.fillRect(
          Math.random() * 512,
          Math.random() * 512,
          Math.random() * 80 + 40,
          Math.random() * 80 + 40
        );

        const texture = new THREE.CanvasTexture(canvas);
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        texture.repeat.set(4, 2); // Repeat texture 4x horizontally, 2x vertically
        texture.needsUpdate = true;
        return texture;
      }

      function createCarpetTexture() {
        const canvas = document.createElement("canvas");
        canvas.width = 512;
        canvas.height = 512;
        const context = canvas.getContext("2d");

        // Damp carpet base
        context.fillStyle = "#595142"; // Damp brownish-gray
        context.fillRect(0, 0, 512, 512);

        // Fibers
        for (let i = 0; i < 1500; i++) {
          context.fillStyle = `rgba(0, 0, 0, ${Math.random() * 0.25})`;
          context.fillRect(
            Math.random() * 512,
            Math.random() * 512,
            1,
            Math.random() * 3 + 1
          );
          context.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.06})`;
          if (i % 6 === 0) context.fillRect(Math.random() * 512, Math.random() * 512, 1, 1);
        }

        // Damp patches (reduced)
        for (let i = 0; i < 8; i++) {
          context.fillStyle = `rgba(0, 0, 0, ${Math.random() * 0.16 + 0.04})`;
          context.beginPath();
          context.arc(
            Math.random() * 512,
            Math.random() * 512,
            Math.random() * 50 + 15,
            0,
            Math.PI * 2
          );
          context.fill();
        }

        const texture = new THREE.CanvasTexture(canvas);
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        texture.repeat.set(5, 5);
        texture.needsUpdate = true;
        return texture;
      }

      function createCeilingTexture() {
        const canvas = document.createElement("canvas");
        canvas.width = 256;
        canvas.height = 256;
        const context = canvas.getContext("2d");

        // Off-white tile
        context.fillStyle = "#c7c7c7";
        context.fillRect(0, 0, 256, 256);

        // Border
        context.strokeStyle = "#888";
        context.lineWidth = 8;
        context.strokeRect(0, 0, 256, 256);

        // Stains
        for (let i = 0; i < 20; i++) {
          context.fillStyle = `rgba(139, 69, 19, ${Math.random() * 0.1})`; // Brownish
          context.beginPath();
          context.arc(
            Math.random() * 256,
            Math.random() * 256,
            Math.random() * 30 + 10,
            0,
            Math.PI * 2
          );
          context.fill();
        }

        const texture = new THREE.CanvasTexture(canvas);
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        texture.repeat.set(1, 1);
        return texture;
      }

      // ... (rest of file continues)


